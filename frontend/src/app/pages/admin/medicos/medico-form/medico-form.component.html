<div class="layout-content-container flex flex-col max-w-4xl mx-auto flex-1">
  <!-- Header -->
  <div class="p-4 space-y-4">
    <div class="flex items-center gap-4">
      <button (click)="goBack()"
              class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
        <span class="material-symbols-outlined">arrow_back</span>
      </button>
      <div>
        <h1 class="text-4xl font-black leading-tight tracking-tight text-gray-900 dark:text-white">
          {{ isEditMode ? 'Editar Médico' : 'Agregar Nuevo Médico' }}
        </h1>
        <p *ngIf="isEditMode" class="text-lg text-gray-600 dark:text-gray-400 mt-1">
          {{ u['nombre'].value }} {{ u['apellido'].value }}
        </p>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="flex justify-center items-center py-20">
      <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-primary"></div>
    </div>

    <!-- Form -->
    <div *ngIf="!loading" class="bg-white dark:bg-gray-800 p-8 rounded-xl border border-gray-200 dark:border-gray-700">
      <form [formGroup]="medicoForm" (ngSubmit)="onSubmit()" class="flex flex-col gap-10">
        
        <!-- Información Básica -->
        <fieldset class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-6" formGroupName="usuario_attributes">
          <div class="col-span-full">
            <legend class="text-xl font-bold pb-2 border-b border-gray-200 dark:border-gray-700 w-full">
              Información Básica
            </legend>
            <p *ngIf="!isEditMode" class="text-sm text-gray-600 dark:text-gray-400 mt-2">
              Crea una nueva cuenta para el médico con sus datos personales.
            </p>
          </div>

          <!-- Nombre -->
          <div class="col-span-1">
            <label class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300" for="nombre">
              Nombre <span class="text-red-500">*</span>
            </label>
            <input formControlName="nombre"
                   class="form-input w-full rounded-lg border-gray-300 dark:border-gray-700 bg-transparent focus:ring-primary/50 focus:border-primary placeholder:text-gray-500"
                   [class.border-red-500]="u['nombre'].invalid && u['nombre'].touched"
                   id="nombre"
                   placeholder="Ej: Ana"
                   type="text"/>
            <p *ngIf="u['nombre'].invalid && u['nombre'].touched" class="text-red-500 text-xs mt-1">
              El nombre es requerido (mínimo 2 caracteres)
            </p>
          </div>

          <!-- Apellido -->
          <div class="col-span-1">
            <label class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300" for="apellido">
              Apellido <span class="text-red-500">*</span>
            </label>
            <input formControlName="apellido"
                   class="form-input w-full rounded-lg border-gray-300 dark:border-gray-700 bg-transparent focus:ring-primary/50 focus:border-primary placeholder:text-gray-500"
                   [class.border-red-500]="u['apellido'].invalid && u['apellido'].touched"
                   id="apellido"
                   placeholder="Ej: Torres"
                   type="text"/>
            <p *ngIf="u['apellido'].invalid && u['apellido'].touched" class="text-red-500 text-xs mt-1">
              El apellido es requerido (mínimo 2 caracteres)
            </p>
          </div>

          <!-- Email -->
          <div class="col-span-1">
            <label class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300" for="email">
              Email <span class="text-red-500">*</span>
            </label>
            <input formControlName="email"
                   class="form-input w-full rounded-lg border-gray-300 dark:border-gray-700 bg-transparent focus:ring-primary/50 focus:border-primary placeholder:text-gray-500"
                   [class.border-red-500]="u['email'].invalid && u['email'].touched"
                   [class.bg-gray-100]="isEditMode"
                   [class.cursor-not-allowed]="isEditMode"
                   [readonly]="isEditMode"
                   id="email"
                   placeholder="ej: ana.torres@mail.com"
                   type="email"/>
            <p *ngIf="u['email'].invalid && u['email'].touched" class="text-red-500 text-xs mt-1">
              Email válido es requerido
            </p>
          </div>

          <!-- Teléfono -->
          <div class="col-span-1">
            <label class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300" for="telefono">
              Teléfono <span class="text-red-500">*</span>
            </label>
            <input formControlName="telefono"
                   class="form-input w-full rounded-lg border-gray-300 dark:border-gray-700 bg-transparent focus:ring-primary/50 focus:border-primary placeholder:text-gray-500"
                   [class.border-red-500]="u['telefono'].invalid && u['telefono'].touched"
                   id="telefono"
                   placeholder="Ej: +51 987 654 321"
                   type="tel"/>
            <p *ngIf="u['telefono'].invalid && u['telefono'].touched" class="text-red-500 text-xs mt-1">
              El teléfono es requerido
            </p>
          </div>

          <!-- Password (solo en crear) -->
          <div *ngIf="!isEditMode" class="col-span-1">
            <label class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300" for="password">
              Contraseña <span class="text-red-500">*</span>
            </label>
            <input formControlName="password"
                   class="form-input w-full rounded-lg border-gray-300 dark:border-gray-700 bg-transparent focus:ring-primary/50 focus:border-primary"
                   [class.border-red-500]="u['password'].invalid && u['password'].touched"
                   id="password"
                   type="password"/>
            <p *ngIf="u['password'].invalid && u['password'].touched" class="text-red-500 text-xs mt-1">
              Contraseña requerida (mínimo 6 caracteres)
            </p>
          </div>

          <!-- Confirm Password (solo en crear) -->
          <div *ngIf="!isEditMode" class="col-span-1">
            <label class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300" for="password_confirmation">
              Confirmar Contraseña <span class="text-red-500">*</span>
            </label>
            <input formControlName="password_confirmation"
                   class="form-input w-full rounded-lg border-gray-300 dark:border-gray-700 bg-transparent focus:ring-primary/50 focus:border-primary"
                   [class.border-red-500]="u['password_confirmation'].invalid && u['password_confirmation'].touched"
                   id="password_confirmation"
                   type="password"/>
            <p *ngIf="u['password_confirmation'].invalid && u['password_confirmation'].touched" class="text-red-500 text-xs mt-1">
              Debe confirmar la contraseña
            </p>
          </div>

          <!-- Dirección -->
          <div class="col-span-full">
            <label class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300" for="direccion">
              Dirección (Opcional)
            </label>
            <input formControlName="direccion"
                   class="form-input w-full rounded-lg border-gray-300 dark:border-gray-700 bg-transparent focus:ring-primary/50 focus:border-primary placeholder:text-gray-500"
                   id="direccion"
                   placeholder="Ej: Av. Principal 123, Lima"
                   type="text"/>
          </div>
        </fieldset>

        <!-- Información Profesional -->
        <fieldset class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-6">
          <div class="col-span-full">
            <legend class="text-xl font-bold pb-2 border-b border-gray-200 dark:border-gray-700 w-full">
              Información Profesional
            </legend>
          </div>

          <!-- Número de Colegiatura -->
          <div class="col-span-1">
            <label class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300" for="numero_colegiatura">
              Número de Colegiatura <span class="text-red-500">*</span>
            </label>
            <input formControlName="numero_colegiatura"
                   class="form-input w-full rounded-lg border-gray-300 dark:border-gray-700 bg-transparent focus:ring-primary/50 focus:border-primary placeholder:text-gray-500"
                   [class.border-red-500]="f['numero_colegiatura'].invalid && f['numero_colegiatura'].touched"
                   id="numero_colegiatura"
                   placeholder="Ej: 12345"
                   type="text"/>
            <p *ngIf="f['numero_colegiatura'].invalid && f['numero_colegiatura'].touched" class="text-red-500 text-xs mt-1">
              El número de colegiatura es requerido
            </p>
          </div>

          <!-- Años de Experiencia -->
          <div class="col-span-1">
            <label class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300" for="anios_experiencia">
              Años de experiencia <span class="text-red-500">*</span>
            </label>
            <input formControlName="anios_experiencia"
                   class="form-input w-full rounded-lg border-gray-300 dark:border-gray-700 bg-transparent focus:ring-primary/50 focus:border-primary placeholder:text-gray-500"
                   [class.border-red-500]="f['anios_experiencia'].invalid && f['anios_experiencia'].touched"
                   id="anios_experiencia"
                   placeholder="Ej: 10"
                   type="number"
                   min="0"/>
            <p *ngIf="f['anios_experiencia'].invalid && f['anios_experiencia'].touched" class="text-red-500 text-xs mt-1">
              Los años de experiencia son requeridos
            </p>
          </div>

          <!-- Costo de Consulta -->
          <div class="col-span-1">
            <label class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300" for="costo_consulta">
              Costo de consulta (S/.) <span class="text-red-500">*</span>
            </label>
            <input formControlName="costo_consulta"
                   class="form-input w-full rounded-lg border-gray-300 dark:border-gray-700 bg-transparent focus:ring-primary/50 focus:border-primary placeholder:text-gray-500"
                   [class.border-red-500]="f['costo_consulta'].invalid && f['costo_consulta'].touched"
                   id="costo_consulta"
                   placeholder="Ej: 150.00"
                   type="number"
                   step="0.01"
                   min="0"/>
            <p *ngIf="f['costo_consulta'].invalid && f['costo_consulta'].touched" class="text-red-500 text-xs mt-1">
              El costo de consulta es requerido
            </p>
          </div>

          <!-- Biografía -->
          <div class="col-span-full">
            <label class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300" for="biografia">
              Biografía
            </label>
            <textarea formControlName="biografia"
                      class="form-textarea w-full rounded-lg border-gray-300 dark:border-gray-700 bg-transparent focus:ring-primary/50 focus:border-primary placeholder:text-gray-500"
                      id="biografia"
                      placeholder="Breve descripción de la trayectoria y enfoque del médico..."
                      rows="4"></textarea>
          </div>
        </fieldset>

        <!-- Especialidades -->
        <fieldset formArrayName="especialidades">
          <div class="col-span-full">
            <div class="flex justify-between items-center pb-2 border-b border-gray-200 dark:border-gray-700 w-full">
              <div>
                <legend class="text-xl font-bold">Especialidades <span class="text-red-500">*</span></legend>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Agrega las especialidades del médico y marca una como principal</p>
              </div>
              <button (click)="addEspecialidad()"
                      class="flex items-center gap-2 px-3 py-1.5 text-sm font-medium rounded-lg border border-primary text-primary hover:bg-primary/10 transition-colors"
                      type="button">
                <span class="material-symbols-outlined text-lg">add</span>
                Añadir Especialidad
              </button>
            </div>
          </div>

          <div class="mt-6 space-y-4">
            <!-- Especialidad item -->
            <div *ngFor="let esp of especialidades.controls; let i = index"
                 [formGroupName]="i"
                 class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 border border-dashed border-gray-300 dark:border-gray-700 rounded-lg relative">
              
              <!-- Select de especialidad -->
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                  Especialidad <span class="text-red-500">*</span>
                </label>
                <select formControlName="especialidad_id"
                        class="form-select w-full rounded-lg border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 focus:ring-primary/50 focus:border-primary">
                  <option value="">Seleccionar especialidad...</option>
                  <option *ngFor="let espDisp of especialidadesDisponibles" [value]="espDisp.id">
                    {{ espDisp.nombre }}
                  </option>
                </select>
              </div>

              <!-- Marcar como principal y eliminar -->
              <div class="flex gap-2 items-end">
                <div class="flex-1 flex items-center gap-2">
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio"
                           [checked]="esp.value.es_principal"
                           (change)="marcarComoPrincipal(i)"
                           class="form-radio h-4 w-4 text-primary bg-gray-50 dark:bg-gray-900 border-gray-300 dark:border-gray-700 focus:ring-primary/50"
                           name="especialidad_principal"/>
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Principal</span>
                  </label>
                </div>
                <button (click)="removeEspecialidad(i)"
                        class="p-2 rounded-full hover:bg-red-100 dark:hover:bg-red-900/20 text-red-600 transition-colors"
                        type="button">
                  <span class="material-symbols-outlined">delete</span>
                </button>
              </div>
            </div>

            <!-- Empty state -->
            <div *ngIf="especialidades.length === 0" class="text-center py-8 text-gray-500 bg-gray-50 dark:bg-gray-900/50 rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-700">
              <span class="material-symbols-outlined text-4xl">medical_services</span>
              <p class="mt-2 font-medium">No hay especialidades agregadas</p>
              <p class="text-sm text-gray-400">Haz clic en "Añadir Especialidad" para comenzar</p>
            </div>

            <!-- Mensaje de validación -->
            <p *ngIf="especialidades.length > 0 && !tieneEspecialidadPrincipal" 
               class="text-orange-600 dark:text-orange-400 text-sm flex items-center gap-1">
              <span class="material-symbols-outlined text-base">warning</span>
              Debes marcar una especialidad como principal
            </p>
          </div>
        </fieldset>

        <!-- Certificaciones -->
        <fieldset formArrayName="certificaciones">
          <div class="col-span-full">
            <div class="flex justify-between items-center pb-2 border-b border-gray-200 dark:border-gray-700 w-full">
              <legend class="text-xl font-bold">Certificaciones</legend>
              <button (click)="addCertificacion()"
                      class="flex items-center gap-2 px-3 py-1.5 text-sm font-medium rounded-lg border border-primary text-primary hover:bg-primary/10 transition-colors"
                      type="button">
                <span class="material-symbols-outlined text-lg">add</span>
                Añadir Certificación
              </button>
            </div>
          </div>

          <div class="mt-6 space-y-4">
            <!-- Nueva certificación -->
            <div *ngFor="let cert of certificaciones.controls; let i = index"
                 [formGroupName]="i"
                 class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 border border-dashed border-gray-300 dark:border-gray-700 rounded-lg relative">
              <div class="md:col-span-1">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                  Certificación
                </label>
                <select formControlName="certificacion_id"
                        class="form-select w-full rounded-lg border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 focus:ring-primary/50 focus:border-primary">
                  <option value="">Seleccionar certificación</option>
                  <option *ngFor="let certDisp of certificacionesDisponibles" [value]="certDisp.id">
                    {{ certDisp.nombre }} - {{ certDisp.institucion_emisora }}
                  </option>
                </select>
              </div>
              <div class="flex gap-2 items-end">
                <div class="flex-1">
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Fecha de Obtención (Opcional)
                  </label>
                  <input formControlName="fecha_obtencion"
                         class="form-input w-full rounded-lg border-gray-300 dark:border-gray-700 bg-transparent focus:ring-primary/50 focus:border-primary"
                         type="date"/>
                </div>
                <button (click)="removeCertificacion(i)"
                        class="p-2 rounded-full hover:bg-red-100 dark:hover:bg-red-900/20 text-red-600 transition-colors"
                        type="button">
                  <span class="material-symbols-outlined">delete</span>
                </button>
              </div>
            </div>

            <!-- Empty state -->
            <div *ngIf="certificaciones.length === 0" class="text-center py-8 text-gray-500">
              <span class="material-symbols-outlined text-4xl">workspace_premium</span>
              <p class="mt-2">No hay certificaciones agregadas</p>
              <p class="text-sm text-gray-400">Haz clic en "Añadir Certificación" para comenzar</p>
            </div>
          </div>
        </fieldset>

        <!-- Form Actions -->
        <div class="flex justify-between items-center gap-4 pt-6 border-t border-gray-200 dark:border-gray-700">
          <!-- Delete button (solo en modo edición) -->
          <button *ngIf="isEditMode"
                  (click)="confirmDelete()"
                  class="px-6 py-2.5 text-sm font-medium rounded-lg border border-red-500 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors"
                  type="button">
            Eliminar Médico
          </button>

          <div class="flex items-center gap-4" [class.ml-auto]="!isEditMode">
            <button (click)="cancel()"
                    class="px-6 py-2.5 text-sm font-medium rounded-lg border border-gray-400 text-gray-700 dark:border-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
                    type="button">
              Cancelar
            </button>
            <button [disabled]="submitting"
                    class="px-8 py-2.5 text-sm font-medium rounded-lg bg-primary text-white hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    type="submit">
              <span *ngIf="!submitting">{{ isEditMode ? 'Guardar Cambios' : 'Guardar Médico' }}</span>
              <span *ngIf="submitting">Guardando...</span>
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div *ngIf="showDeleteConfirm" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md">
    <div class="p-6 text-center">
      <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-red-100 dark:bg-red-900/20">
        <span class="material-symbols-outlined text-red-600 text-3xl">warning</span>
      </div>
      <h3 class="mt-5 text-xl font-semibold text-gray-900 dark:text-white">¿Estás seguro?</h3>
      <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
        Esta acción desactivará al médico. No se puede deshacer.
      </p>
    </div>
    <div class="flex justify-center items-center gap-4 p-4 pb-6 bg-gray-50 dark:bg-gray-900/50 rounded-b-xl">
      <button (click)="cancelDelete()"
              class="w-full px-4 py-2 text-sm font-medium rounded-lg border border-gray-400 text-gray-700 dark:border-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
        Cancelar
      </button>
      <button (click)="deleteMedico()"
              class="w-full px-4 py-2 text-sm font-medium rounded-lg bg-red-600 text-white hover:bg-red-700 transition-colors">
        Sí, eliminar
      </button>
    </div>
  </div>
</div>
