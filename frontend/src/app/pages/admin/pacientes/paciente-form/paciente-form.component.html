<div class="w-full max-w-4xl mx-auto">
  <!-- Header -->
  <header class="mb-8">
    <button (click)="goBack()"
            class="inline-flex items-center gap-2 text-gray-600 dark:text-gray-400 hover:text-primary mb-4">
      <span class="material-symbols-outlined">arrow_back</span>
      <span>Volver a lista</span>
    </button>
    <h1 class="text-4xl font-black leading-tight tracking-tight text-gray-900 dark:text-white">
      {{ isEditMode ? 'Editar Paciente' : 'Agregar Nuevo Paciente' }}
    </h1>
    <p class="text-gray-600 dark:text-gray-400 mt-1">
      {{ isEditMode ? u['nombre'].value + ' ' + u['apellido'].value : 'Rellene los campos a continuación para registrar un nuevo paciente en el sistema.' }}
    </p>
  </header>

  <!-- Loading State -->
  <div *ngIf="loading" class="flex justify-center items-center py-20">
    <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-primary"></div>
  </div>

  <!-- Form -->
  <form *ngIf="!loading" [formGroup]="pacienteForm" (ngSubmit)="onSubmit()" class="space-y-10">
    
    <!-- Información Personal -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
      <h2 class="text-xl font-bold mb-6 pb-4 border-b border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white">
        Información Personal
      </h2>
      <div formGroupName="usuario_attributes" class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Nombre -->
        <div>
          <label class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300" for="nombre">
            Nombre <span class="text-red-500">*</span>
          </label>
          <input formControlName="nombre"
                 class="form-input w-full rounded-lg border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-primary/50 focus:border-primary placeholder:text-gray-500"
                 [class.border-red-500]="u['nombre'].invalid && u['nombre'].touched"
                 id="nombre"
                 placeholder="Ej. Juan"
                 type="text"/>
          <p *ngIf="u['nombre'].invalid && u['nombre'].touched" class="text-red-500 text-xs mt-1">
            El nombre es requerido
          </p>
        </div>

        <!-- Apellido -->
        <div>
          <label class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300" for="apellido">
            Apellido <span class="text-red-500">*</span>
          </label>
          <input formControlName="apellido"
                 class="form-input w-full rounded-lg border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-primary/50 focus:border-primary placeholder:text-gray-500"
                 [class.border-red-500]="u['apellido'].invalid && u['apellido'].touched"
                 id="apellido"
                 placeholder="Ej. Pérez"
                 type="text"/>
          <p *ngIf="u['apellido'].invalid && u['apellido'].touched" class="text-red-500 text-xs mt-1">
            El apellido es requerido
          </p>
        </div>

        <!-- Email -->
        <div>
          <label class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300" for="email">
            Email <span class="text-red-500">*</span>
          </label>
          <input formControlName="email"
                 class="form-input w-full rounded-lg border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-primary/50 focus:border-primary placeholder:text-gray-500"
                 [class.border-red-500]="u['email'].invalid && u['email'].touched"
                 [class.bg-gray-100]="isEditMode"
                 [class.cursor-not-allowed]="isEditMode"
                 [readonly]="isEditMode"
                 id="email"
                 placeholder="ej. juan.perez@correo.com"
                 type="email"/>
          <p *ngIf="u['email'].invalid && u['email'].touched" class="text-red-500 text-xs mt-1">
            Email válido es requerido
          </p>
        </div>

        <!-- Teléfono -->
        <div>
          <label class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300" for="telefono">
            Teléfono <span class="text-red-500">*</span>
          </label>
          <input formControlName="telefono"
                 class="form-input w-full rounded-lg border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-primary/50 focus:border-primary placeholder:text-gray-500"
                 [class.border-red-500]="u['telefono'].invalid && u['telefono'].touched"
                 id="telefono"
                 placeholder="Ej. +51 987 654 321"
                 type="tel"/>
          <p *ngIf="u['telefono'].invalid && u['telefono'].touched" class="text-red-500 text-xs mt-1">
            El teléfono es requerido
          </p>
        </div>

        <!-- Dirección -->
        <div class="md:col-span-2">
          <label class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300" for="direccion">
            Dirección
          </label>
          <input formControlName="direccion"
                 class="form-input w-full rounded-lg border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-primary/50 focus:border-primary placeholder:text-gray-500"
                 id="direccion"
                 placeholder="Ej. Av. Principal 123, Lima"
                 type="text"/>
        </div>
      </div>

      <!-- Campos fuera de usuario_attributes -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
        <!-- Fecha de Nacimiento -->
        <div>
          <label class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300" for="fecha_nacimiento">
            Fecha de Nacimiento <span class="text-red-500">*</span>
          </label>
          <input formControlName="fecha_nacimiento"
                 class="form-input w-full rounded-lg border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-primary/50 focus:border-primary"
                 [class.border-red-500]="f['fecha_nacimiento'].invalid && f['fecha_nacimiento'].touched"
                 id="fecha_nacimiento"
                 type="date"/>
          <p *ngIf="f['fecha_nacimiento'].invalid && f['fecha_nacimiento'].touched" class="text-red-500 text-xs mt-1">
            La fecha de nacimiento es requerida
          </p>
        </div>

        <!-- Género -->
        <div>
          <label class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300">
            Género <span class="text-red-500">*</span>
          </label>
          <div class="flex items-center gap-6 mt-3">
            <label *ngFor="let genero of generos" class="flex items-center gap-2 cursor-pointer">
              <input formControlName="genero"
                     [value]="genero"
                     class="form-radio h-4 w-4 text-primary bg-gray-50 dark:bg-gray-900 border-gray-300 dark:border-gray-700 focus:ring-primary/50"
                     name="genero"
                     type="radio"/>
              <span class="text-sm text-gray-700 dark:text-gray-300">{{ genero }}</span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Información de Acceso (Solo en Crear) -->
    <div *ngIf="!isEditMode" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
      <h2 class="text-xl font-bold mb-6 pb-4 border-b border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white">
        Información de Acceso
      </h2>
      <div formGroupName="usuario_attributes" class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Password -->
        <div>
          <label class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300" for="password">
            Contraseña <span class="text-red-500">*</span>
          </label>
          <input formControlName="password"
                 class="form-input w-full rounded-lg border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-primary/50 focus:border-primary"
                 [class.border-red-500]="u['password'].invalid && u['password'].touched"
                 id="password"
                 placeholder="••••••••"
                 type="password"/>
          <p *ngIf="u['password'].invalid && u['password'].touched" class="text-red-500 text-xs mt-1">
            Contraseña requerida (mínimo 6 caracteres)
          </p>
        </div>

        <!-- Confirmar Password -->
        <div>
          <label class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300" for="password_confirmation">
            Confirmar Contraseña <span class="text-red-500">*</span>
          </label>
          <input formControlName="password_confirmation"
                 class="form-input w-full rounded-lg border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-primary/50 focus:border-primary"
                 [class.border-red-500]="u['password_confirmation'].invalid && u['password_confirmation'].touched"
                 id="password_confirmation"
                 placeholder="••••••••"
                 type="password"/>
          <p *ngIf="u['password_confirmation'].invalid && u['password_confirmation'].touched" class="text-red-500 text-xs mt-1">
            Debe confirmar la contraseña
          </p>
        </div>
      </div>
    </div>

    <!-- Información Médica -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
      <h2 class="text-xl font-bold mb-6 pb-4 border-b border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white">
        Información Médica
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Tipo de Documento -->
        <div>
          <label class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300" for="tipo_documento">
            Tipo de Documento <span class="text-red-500">*</span>
          </label>
          <select formControlName="tipo_documento"
                  class="form-select w-full rounded-lg border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-primary/50 focus:border-primary"
                  id="tipo_documento">
            <option *ngFor="let tipo of tiposDocumento" [value]="tipo">{{ tipo }}</option>
          </select>
        </div>

        <!-- Número de Documento -->
        <div>
          <label class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300" for="numero_documento">
            Número de Documento <span class="text-red-500">*</span>
          </label>
          <input formControlName="numero_documento"
                 class="form-input w-full rounded-lg border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-primary/50 focus:border-primary placeholder:text-gray-500"
                 [class.border-red-500]="f['numero_documento'].invalid && f['numero_documento'].touched"
                 id="numero_documento"
                 placeholder="Ej. 12345678A"
                 type="text"/>
          <p *ngIf="f['numero_documento'].invalid && f['numero_documento'].touched" class="text-red-500 text-xs mt-1">
            El número de documento es requerido
          </p>
        </div>

        <!-- Grupo Sanguíneo -->
        <div class="md:col-span-2">
          <label class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300" for="grupo_sanguineo">
            Grupo Sanguíneo
          </label>
          <select formControlName="grupo_sanguineo"
                  class="form-select w-full md:w-1/2 rounded-lg border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-primary/50 focus:border-primary"
                  id="grupo_sanguineo">
            <option value="">Seleccionar...</option>
            <option *ngFor="let grupo of gruposSanguineos" [value]="grupo">{{ grupo }}</option>
          </select>
        </div>

        <!-- Alergias -->
        <div class="md:col-span-2">
          <label class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300" for="alergias">
            Alergias
          </label>
          <textarea formControlName="alergias"
                    class="form-textarea w-full rounded-lg border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-primary/50 focus:border-primary placeholder:text-gray-500"
                    id="alergias"
                    placeholder="Ej. Penicilina, frutos secos..."
                    rows="3"></textarea>
        </div>


        <!-- Observaciones -->
        <div class="md:col-span-2">
          <label class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300" for="observaciones">
            Observaciones
          </label>
          <textarea formControlName="observaciones"
                    class="form-textarea w-full rounded-lg border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-primary/50 focus:border-primary placeholder:text-gray-500"
                    id="observaciones"
                    placeholder="Añadir cualquier observación médica relevante..."
                    rows="3"></textarea>
        </div>
      </div>
    </div>


    <!-- Form Actions -->
    <div class="flex justify-end gap-4 pt-4">
      <button *ngIf="isEditMode"
              (click)="confirmDelete()"
              class="flex items-center gap-2 text-red-700 dark:text-red-500 hover:text-red-600 dark:hover:text-red-400 font-semibold text-sm"
              type="button">
        <span class="material-symbols-outlined">delete_forever</span>
        Eliminar Paciente
      </button>

      <div class="flex items-center gap-4 ml-auto">
        <button (click)="cancel()"
                class="px-6 py-3 rounded-lg border border-gray-400 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 text-sm font-bold transition-colors"
                type="button">
          Cancelar
        </button>
        <button [disabled]="submitting"
                class="px-6 py-3 rounded-lg bg-primary text-white text-sm font-bold hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                type="submit">
          <span *ngIf="!submitting">{{ isEditMode ? 'Guardar Cambios' : 'Crear Paciente' }}</span>
          <span *ngIf="submitting">Guardando...</span>
        </button>
      </div>
    </div>
  </form>
</div>

<!-- Delete Confirmation Modal -->
<div *ngIf="showDeleteConfirm" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md">
    <div class="p-6 text-center">
      <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-red-100 dark:bg-red-900/20">
        <span class="material-symbols-outlined text-red-600 text-3xl">warning</span>
      </div>
      <h3 class="mt-5 text-xl font-semibold text-gray-900 dark:text-white">¿Estás seguro?</h3>
      <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
        Esta acción desactivará al paciente. No se puede deshacer.
      </p>
    </div>
    <div class="flex justify-center items-center gap-4 p-4 pb-6 bg-gray-50 dark:bg-gray-900/50 rounded-b-xl">
      <button (click)="cancelDelete()"
              class="w-full px-4 py-2 text-sm font-medium rounded-lg border border-gray-400 text-gray-700 dark:border-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
        Cancelar
      </button>
      <button (click)="deletePaciente()"
              class="w-full px-4 py-2 text-sm font-medium rounded-lg bg-red-600 text-white hover:bg-red-700 transition-colors">
        Sí, eliminar
      </button>
    </div>
  </div>
</div>
