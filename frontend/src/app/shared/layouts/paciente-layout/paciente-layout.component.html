<div class="relative flex min-h-screen w-full">
  <!-- Sidebar Desktop -->
  <aside class="flex-col w-64 bg-[#B71C1C] text-white fixed h-full hidden lg:flex z-20">
    <div class="flex items-center justify-center h-20 border-b border-white/20">
      <img src="/images/logo_simbolo_blanco.png" 
      alt="Logo Blume" 
      class="w-8 h-8 object-contain">
      <h1 class="text-2xl font-bold ml-2">blume</h1>
    </div>
    
    <div class="flex flex-col items-center p-4 gap-4">
      <img 
        [src]="currentUser?.foto_url || 'https://ui-avatars.com/api/?name=' + nombreCompleto + '&size=200&background=ffffff&color=B71C1C'" 
        [alt]="'Foto de ' + nombreCompleto"
        class="rounded-full size-16 object-cover border-2 border-white/20"
      />
      <h2 class="text-white text-lg font-medium text-center px-2">{{ nombreCompleto }}</h2>
    </div>
    
    <nav class="flex flex-col p-4 space-y-2 flex-grow">
      <a routerLink="/paciente/dashboard" routerLinkActive="bg-primary" [routerLinkActiveOptions]="{exact: true}" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/50 transition-colors">
        <span class="material-symbols-outlined">home</span>
        <p class="text-sm font-medium">Inicio</p>
      </a>
      <a routerLink="/paciente/citas/mis-citas" routerLinkActive="bg-primary" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/50 transition-colors">
        <span class="material-symbols-outlined">calendar_month</span>
        <p class="text-sm font-medium">Mis Citas</p>
      </a>
      <a routerLink="/paciente/citas/medicos" routerLinkActive="bg-primary" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/50 transition-colors">
        <span class="material-symbols-outlined">group</span>
        <p class="text-sm font-medium">Médicos</p>
      </a>
      <a routerLink="/paciente/notificaciones" routerLinkActive="bg-primary" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/50 transition-colors">
        <span class="material-symbols-outlined">notifications</span>
        <p class="text-sm font-medium">Notificaciones</p>
      </a>
      <a routerLink="/paciente/mi-perfil" routerLinkActive="bg-primary" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/50 transition-colors">
        <span class="material-symbols-outlined">person</span>
        <p class="text-sm font-medium">Mi Perfil</p>
      </a>
    </nav>
    
    <div class="p-4 border-t border-white/20 space-y-2">
      <!-- Dark Mode Toggle -->
      <button 
        (click)="themeService.toggleTheme()" 
        class="flex w-full items-center justify-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/50 transition-colors"
      >
        <span class="material-symbols-outlined" *ngIf="!themeService.isDarkMode()">dark_mode</span>
        <span class="material-symbols-outlined" *ngIf="themeService.isDarkMode()">light_mode</span>
        <span class="truncate">{{ themeService.isDarkMode() ? 'Modo Claro' : 'Modo Oscuro' }}</span>
      </button>
      
      <button (click)="cerrarSesion()" class="flex w-full items-center justify-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/50 transition-colors">
        <span class="material-symbols-outlined">logout</span>
        <span class="truncate">Cerrar Sesión</span>
      </button>
    </div>
  </aside>

  <!-- Mobile Sidebar Overlay -->
  <div *ngIf="sidebarOpen" (click)="toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 lg:hidden"></div>

  <!-- Mobile Sidebar -->
  <aside [class.translate-x-0]="sidebarOpen" class="flex-col w-64 bg-[#B71C1C] text-white fixed h-full flex z-40 lg:hidden transform -translate-x-full transition-transform duration-300 ease-in-out">
    <div class="flex items-center justify-between h-20 border-b border-white/20 px-4">
      <div class="flex items-center gap-2">
        <svg class="w-8 h-8 text-white" fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
          <path clip-rule="evenodd" d="M24 18.4228L42 11.475V34.3663C42 34.7796 41.7457 35.1504 41.3601 35.2992L24 42V18.4228Z" fill="currentColor" fill-rule="evenodd"></path>
          <path clip-rule="evenodd" d="M24 8.18819L33.4123 11.574L24 15.2071L14.5877 11.574L24 8.18819ZM9 15.8487L21 20.4805V37.6263L9 32.9945V15.8487ZM27 37.6263V20.4805L39 15.8487V32.9945L27 37.6263ZM25.354 2.29885C24.4788 1.98402 23.5212 1.98402 22.646 2.29885L4.98454 8.65208C3.7939 9.08038 3 10.2097 3 11.475V34.3663C3 36.0196 4.01719 37.5026 5.55962 38.098L22.9197 44.7987C23.6149 45.0671 24.3851 45.0671 25.0803 44.7987L42.4404 38.098C43.9828 37.5026 45 36.0196 45 34.3663V11.475C45 10.2097 44.2061 9.08038 43.0155 8.65208L25.354 2.29885Z" fill="currentColor" fill-rule="evenodd"></path>
        </svg>
        <h1 class="text-2xl font-bold">blume</h1>
      </div>
      <button (click)="toggleSidebar()" class="text-white">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    
    <div class="flex flex-col items-center p-4 gap-4">
      <img 
        [src]="currentUser?.foto_url || 'https://ui-avatars.com/api/?name=' + nombreCompleto + '&size=200&background=ffffff&color=B71C1C'" 
        [alt]="'Foto de ' + nombreCompleto"
        class="rounded-full size-16 object-cover border-2 border-white/20"
      />
      <h2 class="text-white text-lg font-medium text-center px-2">{{ nombreCompleto }}</h2>
    </div>
    
    <nav class="flex flex-col p-4 space-y-2 flex-grow">
      <a (click)="toggleSidebar()" routerLink="/paciente/dashboard" routerLinkActive="bg-primary" [routerLinkActiveOptions]="{exact: true}" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/50 transition-colors">
        <span class="material-symbols-outlined">home</span>
        <p class="text-sm font-medium">Inicio</p>
      </a>
      <a (click)="toggleSidebar()" routerLink="/paciente/citas/mis-citas" routerLinkActive="bg-primary" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/50 transition-colors">
        <span class="material-symbols-outlined">calendar_month</span>
        <p class="text-sm font-medium">Mis Citas</p>
      </a>
      <a (click)="toggleSidebar()" routerLink="/paciente/citas/medicos" routerLinkActive="bg-primary" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/50 transition-colors">
        <span class="material-symbols-outlined">group</span>
        <p class="text-sm font-medium">Médicos</p>
      </a>
      <a (click)="toggleSidebar()" routerLink="/paciente/notificaciones" routerLinkActive="bg-primary" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/50 transition-colors">
        <span class="material-symbols-outlined">notifications</span>
        <p class="text-sm font-medium">Notificaciones</p>
      </a>
      <a (click)="toggleSidebar()" routerLink="/paciente/mi-perfil" routerLinkActive="bg-primary" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/50 transition-colors">
        <span class="material-symbols-outlined">person</span>
        <p class="text-sm font-medium">Mi Perfil</p>
      </a>
    </nav>
    
    <div class="p-4 border-t border-white/20 space-y-2">
      <!-- Dark Mode Toggle -->
      <button 
        (click)="themeService.toggleTheme()" 
        class="flex w-full items-center justify-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/50 transition-colors"
      >
        <span class="material-symbols-outlined" *ngIf="!themeService.isDarkMode()">dark_mode</span>
        <span class="material-symbols-outlined" *ngIf="themeService.isDarkMode()">light_mode</span>
        <span class="truncate">{{ themeService.isDarkMode() ? 'Modo Claro' : 'Modo Oscuro' }}</span>
      </button>
      
      <button (click)="cerrarSesion()" class="flex w-full items-center justify-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/50 transition-colors">
        <span class="material-symbols-outlined">logout</span>
        <span class="truncate">Cerrar Sesión</span>
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <div class="flex-1 lg:ml-64">
    <!-- Topbar -->
    <header class="flex items-center justify-between whitespace-nowrap border-b border-b-[#e7d0d1] dark:border-b-gray-700 bg-white dark:bg-background-dark/80 backdrop-blur-sm sticky top-0 z-10 h-20 px-6">
      <div class="flex items-center gap-4">
        <button (click)="toggleSidebar()" class="lg:hidden text-gray-800 dark:text-white">
          <span class="material-symbols-outlined">menu</span>
        </button>
        <ng-content select="[breadcrumb]"></ng-content>
      </div>
      <div class="flex flex-1 justify-end items-center gap-4">
        <div class="hidden md:block">
          <form (submit)="buscar()" class="flex flex-col min-w-40 !h-10 max-w-sm">
            <div class="flex w-full flex-1 items-stretch rounded-lg h-full">
              <div class="text-gray-500 dark:text-gray-400 flex border border-r-0 border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-800 items-center justify-center pl-4 rounded-l-lg">
                <span class="material-symbols-outlined">search</span>
              </div>
              <input 
                [(ngModel)]="searchQuery"
                name="search"
                class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-r-lg text-gray-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-800 h-full placeholder:text-gray-500 dark:placeholder-gray-400 px-4 text-sm font-normal leading-normal" 
                placeholder="Buscar médicos, especialidades..." 
              />
            </div>
          </form>
        </div>
        
        <!-- Dark Mode Toggle -->
        <button 
          (click)="themeService.toggleTheme()" 
          class="flex cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 w-10 bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-white hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
          [title]="themeService.isDarkMode() ? 'Cambiar a modo claro' : 'Cambiar a modo oscuro'"
        >
          <span class="material-symbols-outlined" *ngIf="!themeService.isDarkMode()">dark_mode</span>
          <span class="material-symbols-outlined" *ngIf="themeService.isDarkMode()">light_mode</span>
        </button>
        
        <!-- Notificaciones Dropdown -->
        <div class="relative">
          <button (click)="toggleNotificaciones()" class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 w-10 bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-white relative hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
            <span class="material-symbols-outlined">notifications</span>
            <span *ngIf="notificacionesNoLeidas > 0" class="absolute top-1 right-1.5 flex h-2.5 w-2.5">
              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-primary opacity-75"></span>
              <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-primary"></span>
            </span>
          </button>

          <!-- Dropdown Panel -->
          <div *ngIf="notificacionesDropdownOpen" class="absolute right-0 mt-2 w-96 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 z-50 max-h-[500px] overflow-hidden flex flex-col">
            <!-- Header -->
            <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Notificaciones</h3>
              <button (click)="marcarTodasLeidas()" class="text-sm text-primary hover:underline font-medium">
                Marcar todas como leídas
              </button>
            </div>

            <!-- Lista de notificaciones -->
            <div class="overflow-y-auto flex-1">
              <div *ngIf="notificaciones.length === 0" class="p-8 text-center">
                <span class="material-symbols-outlined text-4xl text-gray-300 dark:text-gray-600 mb-2 block">notifications_off</span>
                <p class="text-gray-500 dark:text-gray-400">No tienes notificaciones</p>
              </div>

              <div *ngFor="let notif of notificaciones" 
                   (click)="handleNotificacionClick(notif)"
                   class="p-4 border-b border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 cursor-pointer transition-colors"
                   [class.bg-blue-50]="!notif.leida"
                   [class.dark:bg-blue-900/10]="!notif.leida">
                <div class="flex items-start gap-3">
                  <div class="flex items-center justify-center size-10 rounded-full flex-shrink-0" [ngClass]="{
                    'bg-blue-100 dark:bg-blue-900/50': notif.tipo === 'cita_creada',
                    'bg-orange-100 dark:bg-orange-900/50': notif.tipo === 'recordatorio',
                    'bg-green-100 dark:bg-green-900/50': notif.tipo === 'cita_confirmada',
                    'bg-red-100 dark:bg-red-900/50': notif.tipo === 'cita_cancelada'
                  }">
                    <span class="material-symbols-outlined text-xl" [ngClass]="{
                      'text-blue-600 dark:text-blue-400': notif.tipo === 'cita_creada',
                      'text-orange-600 dark:text-orange-400': notif.tipo === 'recordatorio',
                      'text-green-600 dark:text-green-400': notif.tipo === 'cita_confirmada',
                      'text-red-600 dark:text-red-400': notif.tipo === 'cita_cancelada'
                    }">{{ getNotificacionIcono(notif.tipo) }}</span>
                  </div>
                  <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900 dark:text-gray-100" [class.font-bold]="!notif.leida">
                      {{ notif.mensaje }}
                    </p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                      {{ getTiempoRelativo(notif.created_at) }}
                    </p>
                  </div>
                  <div class="w-2.5 h-2.5 rounded-full mt-1.5 flex-shrink-0" [ngClass]="notif.leida ? 'bg-transparent' : 'bg-primary'"></div>
                </div>
              </div>
            </div>

            <!-- Footer -->
            <div class="p-3 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50">
              <button (click)="navegarANotificaciones()" class="w-full text-center text-sm text-primary hover:underline font-medium py-1">
                Ver todas las notificaciones
              </button>
            </div>
          </div>
        </div>
        <img 
          [src]="currentUser?.foto_url || 'https://ui-avatars.com/api/?name=' + nombreCompleto + '&size=200&background=B71C1C&color=fff'" 
          [alt]="'Foto de ' + nombreCompleto"
          class="rounded-full size-10 object-cover cursor-pointer border-2 border-gray-200 dark:border-gray-700 hover:border-primary transition-colors"
          (click)="navegarAPerfil()"
        />
      </div>
    </header>

    <!-- Page Content -->
    <main class="min-h-screen bg-background-light dark:bg-background-dark p-6">
      <router-outlet></router-outlet>
    </main>
  </div>
</div>
